# Day 14: ToDoアプリケーションの要件定義と設計 - 解答例

## 課題1: 要件定義書の作成

```
# ToDoアプリケーション要件定義書

## 1. はじめに

### 1.1 目的
本書は、ToDoアプリケーションの要件を定義するものである。

### 1.2 対象読者
- 開発者
- テスト担当者
- プロジェクト管理者

### 1.3 用語定義
- ToDo: タスクや作業項目
- ユーザー: システムを利用する人

## 2. 機能要件

### 2.1 ユーザー管理機能
- ユーザー登録
  - ユーザー名とパスワードを入力して登録
  - ユーザー名は一意であること
  - パスワードは8文字以上であること
- ログイン・ログアウト
  - ユーザー名とパスワードによる認証
  - セッション管理
- パスワード変更
  - 現在のパスワードを確認後、新しいパスワードに変更

### 2.2 ToDo管理機能
- ToDoの一覧表示
  - ログインユーザーのToDoを一覧表示
  - 完了状態によるフィルタリング
- ToDoの詳細表示
  - タイトル、説明、完了状態、作成日時、更新日時を表示
- ToDoの新規作成
  - タイトル（必須）と説明を入力して作成
- ToDoの編集
  - タイトル、説明、完了状態を編集
- ToDoの削除
  - 確認後に削除
- ToDoの完了・未完了の切り替え
  - チェックボックスで切り替え

### 2.3 検索・フィルタリング機能
- タイトルによる検索
  - 部分一致検索
- 完了状態によるフィルタリング
  - 全て、完了、未完了
- 作成日時によるソート
  - 昇順・降順

## 3. 非機能要件

### 3.1 パフォーマンス
- ページロード時間は3秒以内
- 100件のToDoを表示しても応答時間が劣化しない

### 3.2 セキュリティ
- パスワードはハッシュ化して保存
- クロスサイトスクリプティング（XSS）対策
- クロスサイトリクエストフォージェリ（CSRF）対策
- SQLインジェクション対策

### 3.3 可用性
- 24時間365日の稼働
- 計画的なメンテナンス時間を除き、99.9%の可用性

### 3.4 保守性
- コードの可読性と一貫性
- 適切なドキュメント
- テストの自動化

### 3.5 ユーザビリティ
- 直感的なUI
- レスポンシブデザイン
- アクセシビリティへの配慮

## 4. ユースケース

### 4.1 ユーザー登録
- アクター: 未登録ユーザー
- 前提条件: なし
- 基本フロー:
  1. ユーザーが登録ページにアクセスする
  2. ユーザー名、パスワードを入力する
  3. 登録ボタンをクリックする
  4. システムがユーザー情報を検証する
  5. システムがユーザー情報を保存する
  6. システムがログインページにリダイレクトする
- 代替フロー:
  - 4a. ユーザー名が既に使用されている場合
    1. システムがエラーメッセージを表示する
    2. ユーザーが別のユーザー名を入力する
  - 4b. パスワードが要件を満たさない場合
    1. システムがエラーメッセージを表示する
    2. ユーザーが別のパスワードを入力する

### 4.2 ログイン
- アクター: 登録済みユーザー
- 前提条件: ユーザーが登録済みであること
- 基本フロー:
  1. ユーザーがログインページにアクセスする
  2. ユーザー名、パスワードを入力する
  3. ログインボタンをクリックする
  4. システムが認証情報を検証する
  5. システムがToDoリストページにリダイレクトする
- 代替フロー:
  - 4a. 認証情報が不正な場合
    1. システムがエラーメッセージを表示する
    2. ユーザーが認証情報を再入力する

### 4.3 ToDoの作成
- アクター: ログイン済みユーザー
- 前提条件: ユーザーがログイン済みであること
- 基本フロー:
  1. ユーザーがToDoリストページで「新規作成」ボタンをクリックする
  2. システムが新規作成フォームを表示する
  3. ユーザーがタイトル、説明を入力する
  4. ユーザーが保存ボタンをクリックする
  5. システムがToDoを保存する
  6. システムがToDoリストページを更新する
- 代替フロー:
  - 4a. 必須項目が未入力の場合
    1. システムがエラーメッセージを表示する
    2. ユーザーが必須項目を入力する

### 4.4 ToDoの編集
- アクター: ログイン済みユーザー
- 前提条件: ユーザーがログイン済みであり、ToDoが存在すること
- 基本フロー:
  1. ユーザーがToDoリストページで編集したいToDoの「編集」ボタンをクリックする
  2. システムが編集フォームを表示する
  3. ユーザーがタイトル、説明を編集する
  4. ユーザーが保存ボタンをクリックする
  5. システムがToDoを更新する
  6. システムがToDoリストページを更新する
- 代替フロー:
  - 4a. 必須項目が未入力の場合
    1. システムがエラーメッセージを表示する
    2. ユーザーが必須項目を入力する

### 4.5 ToDoの削除
- アクター: ログイン済みユーザー
- 前提条件: ユーザーがログイン済みであり、ToDoが存在すること
- 基本フロー:
  1. ユーザーがToDoリストページで削除したいToDoの「削除」ボタンをクリックする
  2. システムが確認ダイアログを表示する
  3. ユーザーが「はい」をクリックする
  4. システムがToDoを削除する
  5. システムがToDoリストページを更新する
- 代替フロー:
  - 3a. ユーザーが「いいえ」をクリックした場合
    1. システムが確認ダイアログを閉じる
    2. 操作を中止する

### 4.6 ToDoの完了・未完了の切り替え
- アクター: ログイン済みユーザー
- 前提条件: ユーザーがログイン済みであり、ToDoが存在すること
- 基本フロー:
  1. ユーザーがToDoリストページでToDoの完了チェックボックスをクリックする
  2. システムがToDoの完了状態を切り替える
  3. システムがToDoリストページを更新する

## 5. 画面遷移図

```
[ログイン画面] -----> [ToDoリスト画面] -----> [ToDo詳細画面]
    |                      |                      |
    |                      |                      |
    v                      v                      v
[ユーザー登録画面]    [ToDo作成画面]        [ToDo編集画面]
```

## 6. 制約条件

### 6.1 技術的制約
- 言語: Java
- フレームワーク: Spring Framework (TERASOLUNA)
- データベース: PostgreSQL
- フロントエンド: JSP, HTML, CSS, JavaScript

### 6.2 環境的制約
- サーバー: Tomcat
- JDK: 11以上
- メモリ: 2GB以上

## 7. 付録

### 7.1 画面一覧
1. ログイン画面
2. ユーザー登録画面
3. ToDoリスト画面
4. ToDo詳細画面
5. ToDo作成画面
6. ToDo編集画面

### 7.2 エラーメッセージ一覧
- ユーザー名が既に使用されています
- パスワードは8文字以上である必要があります
- タイトルは必須です
- ユーザー名またはパスワードが正しくありません
```

## 課題2: データベース設計

**ER図**

```
+---------------+       +---------------+       +---------------+
|     users     |       |  user_todos   |       |     todos     |
+---------------+       +---------------+       +---------------+
| id (PK)       |       | user_id (PK)  |       | id (PK)       |
| username      |       | todo_id (PK)  |       | title         |
| password      |       |               |       | description   |
| enabled       |       |               |       | completed     |
| created_at    |       |               |       | created_at    |
| updated_at    |       |               |       | updated_at    |
+---------------+       +---------------+       +---------------+
       |                  |           |                 |
       |                  |           |                 |
       +------------------+           +-----------------+
```

**テーブル定義書**

```
# テーブル定義書

## usersテーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | ユーザーID |
| username | VARCHAR(100) | NOT NULL UNIQUE | ユーザー名 |
| password | VARCHAR(100) | NOT NULL | パスワード（ハッシュ化） |
| enabled | BOOLEAN | NOT NULL DEFAULT TRUE | 有効状態 |
| created_at | TIMESTAMP | NOT NULL | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | 更新日時 |

## todosテーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | SERIAL | PRIMARY KEY | ToDoのID |
| title | VARCHAR(256) | NOT NULL | タイトル |
| description | TEXT | | 説明 |
| completed | BOOLEAN | NOT NULL DEFAULT FALSE | 完了状態 |
| created_at | TIMESTAMP | NOT NULL | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | 更新日時 |

## user_todosテーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| user_id | INTEGER | NOT NULL REFERENCES users(id) | ユーザーID |
| todo_id | INTEGER | NOT NULL REFERENCES todos(id) | ToDoID |
| | | PRIMARY KEY (user_id, todo_id) | 複合主キー |
```

**インデックス設計**

```
# インデックス設計

## usersテーブル

| インデックス名 | カラム | 種類 | 説明 |
|--------------|-------|------|------|
| users_pkey | id | PRIMARY KEY | 主キー |
| idx_users_username | username | UNIQUE | ユーザー名の一意性 |

## todosテーブル

| インデックス名 | カラム | 種類 | 説明 |
|--------------|-------|------|------|
| todos_pkey | id | PRIMARY KEY | 主キー |
| idx_todos_title | title | B-TREE | タイトルによる検索 |
| idx_todos_completed | completed | B-TREE | 完了状態による検索 |
| idx_todos_created_at | created_at | B-TREE | 作成日時によるソート |

## user_todosテーブル

| インデックス名 | カラム | 種類 | 説明 |
|--------------|-------|------|------|
| user_todos_pkey | user_id, todo_id | PRIMARY KEY | 主キー |
| idx_user_todos_user_id | user_id | B-TREE | ユーザーIDによる検索 |
| idx_user_todos_todo_id | todo_id | B-TREE | ToDoIDによる検索 |
```

**制約の設定**

```
# 制約の設定

## usersテーブル

| 制約名 | 種類 | カラム | 説明 |
|-------|------|-------|------|
| users_pkey | PRIMARY KEY | id | 主キー |
| users_username_key | UNIQUE | username | ユーザー名の一意性 |
| chk_users_username_not_empty | CHECK | username | ユーザー名が空でないこと |
| chk_users_password_not_empty | CHECK | password | パスワードが空でないこと |

## todosテーブル

| 制約名 | 種類 | カラム | 説明 |
|-------|------|-------|------|
| todos_pkey | PRIMARY KEY | id | 主キー |
| chk_todos_title_not_empty | CHECK | title | タイトルが空でないこと |

## user_todosテーブル

| 制約名 | 種類 | カラム | 説明 |
|-------|------|-------|------|
| user_todos_pkey | PRIMARY KEY | user_id, todo_id | 主キー |
| fk_user_todos_user_id | FOREIGN KEY | user_id | usersテーブルへの外部キー |
| fk_user_todos_todo_id | FOREIGN KEY | todo_id | todosテーブルへの外部キー |
```

## 課題3: アプリケーション設計

**パッケージ構成**

```
com.example.todo
├── app
│   ├── todo
│   │   ├── TodoController.java
│   │   ├── TodoForm.java
│   │   └── TodoValidator.java
│   └── user
│       ├── UserController.java
│       ├── UserForm.java
│       └── UserValidator.java
├── domain
│   ├── model
│   │   ├── Todo.java
│   │   └── User.java
│   ├── repository
│   │   ├── TodoRepository.java
│   │   └── UserRepository.java
│   └── service
│       ├── todo
│       │   ├── TodoService.java
│       │   └── TodoServiceImpl.java
│       └── user
│           ├── UserService.java
│           └── UserServiceImpl.java
└── infra
    ├── mybatis
    │   ├── repository
    │   │   ├── TodoRepositoryImpl.java
    │   │   └── UserRepositoryImpl.java
    │   └── typehandler
    │       └── LocalDateTimeTypeHandler.java
    └── config
        ├── app
        │   └── ApplicationContextConfig.java
        ├── web
        │   └── WebMvcConfig.java
        └── infra
            └── InfrastructureConfig.java
```

**クラス図**

```
+------------------+       +------------------+       +------------------+
| TodoController   |       | TodoService      |       | TodoRepository   |
+------------------+       +------------------+       +------------------+
| - todoService    |------>| - todoRepository |------>| + findAll()      |
+------------------+       +------------------+       | + findById()     |
| + list()         |       | + findAll()      |       | + findByUserId() |
| + show()         |       | + findById()     |       | + create()       |
| + createForm()   |       | + findByUserId() |       | + update()       |
| + create()       |       | + create()       |       | + delete()       |
| + editForm()     |       | + update()       |       +------------------+
| + edit()         |       | + delete()       |                ^
| + delete()       |       +------------------+                |
+------------------+                ^                          |
                                    |                          |
                                    |                          |
                            +------------------+       +------------------+
                            | TodoServiceImpl  |       | TodoRepositoryImpl|
                            +------------------+       +------------------+
                            | - todoRepository |------>| - sqlSession     |
                            +------------------+       +------------------+
                            | + findAll()      |       | + findAll()      |
                            | + findById()     |       | + findById()     |
                            | + findByUserId() |       | + findByUserId() |
                            | + create()       |       | + create()       |
                            | + update()       |       | + update()       |
                            | + delete()       |       | + delete()       |
                            +------------------+       +------------------+
```

**シーケンス図（ToDoリスト表示の例）**

```
ユーザー        TodoController        TodoService        TodoRepository        DB
   |                  |                    |                    |               |
   | HTTP GET /todos  |                    |                    |               |
   |----------------->|                    |                    |               |
   |                  | findByUserId()     |                    |               |
   |                  |------------------->|                    |               |
   |                  |                    | findByUserId()     |               |
   |                  |                    |------------------->|               |
   |                  |                    |                    | SELECT文実行  |
   |                  |                    |                    |-------------->|
   |                  |                    |                    |               |
   |                  |                    |                    | 結果セット    |
   |                  |                    |                    |<--------------|
   |                  |                    | Todoリスト         |               |
   |                  |                    |<-------------------|               |
   |                  | Todoリスト         |                    |               |
   |                  |<-------------------|                    |               |
   |                  | JSPにデータ設定    |                    |               |
   |                  |----------------    |                    |               |
   |                  |                |   |                    |               |
   |                  |<---------------    |                    |               |
   | HTML応答         |                    |                    |               |
   |<-----------------|                    |                    |               |
   |                  |                    |                    |               |
```

**各レイヤの責務**

```
# 各レイヤの責務

## Webレイヤ（app）
- HTTPリクエストの受け付け
- 入力値の検証
- ビジネスロジックの呼び出し
- モデルへのデータ設定
- ビューの選択
- HTTPレスポンスの生成

## Serviceレイヤ（domain.service）
- トランザクション境界
- ビジネスロジックの実装
- 複数のリポジトリの連携
- 認可チェック
- 入力値の業務的な検証

## Domainレイヤ（domain.model, domain.repository）
- ドメインオブジェクトの定義
- リポジトリインターフェースの定義
- ドメインルールの表現

## Infrastructureレイヤ（infra）
- リポジトリの実装
- データアクセスの実装
- 外部システム連携の実装
- 技術的な共通機能の提供
```

## 課題4: 画面設計

**ワイヤーフレーム（ToDoリスト画面の例）**

```
+------------------------------------------+
|                                          |
|  ToDoアプリケーション    [ログアウト]    |
|                                          |
+------------------------------------------+
|                                          |
|  ようこそ、{ユーザー名}さん              |
|                                          |
|  新規TODO: [                      ] [追加]|
|                                          |
|  表示: [すべて ▼]                        |
|                                          |
|  +------------------------------------+  |
|  | □ 牛乳を買う           [編集][削除]|  |
|  | ■ 報告書を提出する     [編集][削除]|  |
|  | □ 会議の準備をする     [編集][削除]|  |
|  +------------------------------------+  |
|                                          |
+------------------------------------------+
```

**画面遷移図**

```
+---------------+       +---------------+       +---------------+
| ログイン画面  | ----> | ToDoリスト画面 | ----> | ToDo詳細画面  |
+---------------+       +---------------+       +---------------+
       |                       |                       |
       |                       |                       |
       v                       v                       v
+---------------+       +---------------+       +---------------+
|ユーザー登録画面|       | ToDo作成画面  |       | ToDo編集画面  |
+---------------+       +---------------+       +---------------+
```

**入力項目と検証ルール**

```
# 入力項目と検証ルール

## ユーザー登録画面
- ユーザー名
  - 必須
  - 4文字以上100文字以下
  - 英数字のみ
  - 一意性チェック
- パスワード
  - 必須
  - 8文字以上100文字以下
  - 英数字混在
- パスワード（確認）
  - 必須
  - パスワードと一致

## ログイン画面
- ユーザー名
  - 必須
- パスワード
  - 必須

## ToDo作成画面
- タイトル
  - 必須
  - 1文字以上256文字以下
- 説明
  - 任意
  - 1000文字以下

## ToDo編集画面
- タイトル
  - 必須
  - 1文字以上256文字以下
- 説明
  - 任意
  - 1000文字以下
- 完了
  - チェックボックス
```

**エラーメッセージ定義**

```
# エラーメッセージ定義

## ユーザー関連
- ユーザー名は必須です
- ユーザー名は4文字以上100文字以下で入力してください
- ユーザー名は英数字のみ使用できます
- このユーザー名は既に使用されています
- パスワードは必須です
- パスワードは8文字以上100文字以下で入力してください
- パスワードは英字と数字を含める必要があります
- パスワード（確認）はパスワードと一致する必要があります
- ユーザー名またはパスワードが正しくありません

## ToDo関連
- タイトルは必須です
- タイトルは1文字以上256文字以下で入力してください
- 説明は1000文字以下で入力してください
- ToDoが見つかりません
- ToDoの作成に失敗しました
- ToDoの更新に失敗しました
- ToDoの削除に失敗しました
```

### 解説

課題1～4の解答例では、TERASOLUNAフレームワークの推奨アーキテクチャに基づいて、ToDoアプリケーションの要件定義と設計を行いました。

1. **要件定義書**
   - 機能要件と非機能要件を明確に区別
   - ユースケースを詳細に記述
   - 画面遷移図を作成
   - 制約条件を明記

2. **データベース設計**
   - ER図で全体構造を表現
   - テーブル定義書で詳細を記述
   - インデックス設計でパフォーマンスを考慮
   - 制約の設定でデータ整合性を確保

3. **アプリケーション設計**
   - パッケージ構成でレイヤ構造を表現
   - クラス図で静的構造を表現
   - シーケンス図で動的振る舞いを表現
   - 各レイヤの責務を明確に定義

4. **画面設計**
   - ワイヤーフレームで画面レイアウトを表現
   - 画面遷移図で画面間の関係を表現
   - 入力項目と検証ルールでユーザー入力の品質を確保
   - エラーメッセージ定義でユーザーエクスペリエンスを向上

これらの設計ドキュメントは、実装フェーズでの指針となり、品質の高いアプリケーション開発を支援します。特に、TERASOLUNAフレームワークの多層アーキテクチャに準拠した設計により、保守性と拡張性の高いアプリケーションを構築することができます。
